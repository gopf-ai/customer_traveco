# Traveco Forecasting Project Configuration

data:
  # Raw data paths (relative to project root for production app, relative to notebooks for Jupyter)
  raw_path: "data/swisstransfer_f473fe80-56b4-4ff0-8cbb-1bb5e181450a/"
  order_analysis: "20251015 Juni 2025 QS Auftragsanalyse.xlsb"
  tour_assignments: "20251015 QS Tourenaufstellung Juni 2025.xlsx"
  divisions: "20251015 Sparten.xlsx"
  betriebszentralen: "TRAVECO_Betriebszentralen.csv"  # 14 dispatch centers (invoicing units)
  working_days: "TRAVECO_Arbeitstage_2022-laufend_fÃ¼r gopf.com_hb v2.xlsx"

  # NEW: Data files to be provided by client (end of week)
  personnel_costs_file: "TRAVECO_Personnel_Costs_2022_2025.xlsx"
  total_revenue_file: "TRAVECO_Total_Revenue_2022_2025.xlsx"

  # Historic multi-year data configuration
  historic_years: [2022, 2023, 2024, 2025]
  raw_directories:
    2022: "data/raw/2022"
    2023: "data/raw/2023"
    2024: "data/raw/2024"
    2025: "data/raw/2025"

  # Historic master file outputs
  historic_output:
    pkl: "data/processed/historic_orders_2022_2025.pkl"
    csv: "data/processed/historic_orders_2022_2025.csv.gz"
    parquet: "data/processed/historic_orders_2022_2025.parquet"

  # Processed data paths (relative to project root for production app, relative to notebooks for Jupyter)
  processed_path: "data/processed/"
  clean_orders: "clean_orders.csv"
  features_engineered: "features_engineered.csv"
  monthly_aggregated: "monthly_aggregated.csv"

  # Results path (relative to project root for production app, relative to notebooks for Jupyter)
  results_path: "results/"

  # Models path (relative to project root for production app, relative to notebooks for Jupyter)
  models_path: "models/"

# Paths for production application
paths:
  raw_data_dir: "data/swisstransfer_f473fe80-56b4-4ff0-8cbb-1bb5e181450a"
  processed_data_dir: "data/processed"
  models_dir: "models"
  forecasts_dir: "forecasts"
  reports_dir: "reports"

# Data files (for production application convenience)
data_files:
  orders_file: "20251015 Juni 2025 QS Auftragsanalyse.xlsb"
  tours_file: "20251015 QS Tourenaufstellung Juni 2025.xlsx"
  working_days_file: "TRAVECO_Arbeitstage_2022-laufend_fÃ¼r gopf.com_hb v2.xlsx"
  personnel_costs_file: "TRAVECO_Personnel_Costs_2022_2025.xlsx"
  total_revenue_file: "TRAVECO_Total_Revenue_2022_2025.xlsx"

# Target variables for forecasting
features:
  # Core metrics (PRIMARY FOCUS for production forecasting)
  core_metrics:
    - "revenue_total"          # Transportation revenue
    - "personnel_costs"        # NEW: Personnel costs data
    - "external_drivers"       # External carrier orders

  # Additional metrics (backward compatibility)
  target_columns:
    - "revenue"
    - "external_drivers"
    - "personnel_costs"

  # Lag features (in months)
  lag_periods: [1, 3, 6, 12]

  # Temporal features to extract
  temporal_features:
    - "year"
    - "month"
    - "week"
    - "quarter"
    - "day_of_year"
    - "weekday"

# Data filtering rules
filtering:
  # Exclude B&T pickup orders (System B&T with empty customer)
  exclude_bt_pickups: true

  # Exclude Lager (warehouse) orders - not relevant for transport analysis
  exclude_lager_orders: true

  # Carrier number ranges
  internal_carrier_max: 8889  # 1-8889 are TRAVECO internal
  external_carrier_min: 9000  # 9000+ are external carriers

# Validation strategy
validation:
  # Hold out 2024 for validation
  holdout_year: 2024

  # Time series cross-validation
  n_splits: 5

  # Metrics to calculate
  metrics:
    - "mape"
    - "rmse"
    - "mae"
    - "seasonal_mape"
    - "directional_accuracy"

# Model configurations
models:
  # Model A: Prophet (Seasonality-focused)
  prophet:
    yearly_seasonality: true
    weekly_seasonality: false
    daily_seasonality: false
    seasonality_mode: "multiplicative"
    changepoint_prior_scale: 0.05

    # Custom seasonalities
    custom_seasonalities:
      quarterly:
        period: 91.25
        fourier_order: 5
      monthly:
        period: 30.5
        fourier_order: 10

    # Swiss holidays
    include_holidays: true
    country_holidays: "CH"

  # Model A: SARIMAX
  sarimax:
    order: [2, 1, 2]           # (p, d, q) - ARIMA order
    seasonal_order: [1, 1, 1, 12]  # (P, D, Q, s) - Seasonal order
    enforce_stationarity: false
    enforce_invertibility: false

  # Model A: XGBoost
  xgboost:
    n_estimators: 200
    max_depth: 6
    learning_rate: 0.05
    subsample: 0.8
    colsample_bytree: 0.8
    random_state: 42

    # Feature columns (temporal + lag features)
    feature_columns:
      - "month"
      - "quarter"
      - "week"
      - "day_of_year"
      - "weekday"

  # Model B: Weighted Prophet (Time decay-focused)
  weighted_prophet:
    yearly_seasonality: true
    seasonality_mode: "multiplicative"
    changepoint_prior_scale: 0.1  # More responsive to recent changes

    custom_seasonalities:
      quarterly:
        period: 91.25
        fourier_order: 5

  # Model B: Time-weighted ensemble
  ensemble:
    base_model: "random_forest"
    n_estimators: 100
    random_state: 42

# Time decay parameters
time_decay:
  # Exponential decay rate for weighting recent data
  decay_rate: 0.3  # Î» in formula: w(t) = exp(-Î» * (T - t))

  # Year-level decay for ensemble
  year_decay: 0.5  # For year_weight = exp(-0.5 * (2025 - year))

  # Test different decay rates
  test_decay_rates: [0.2, 0.3, 0.4, 0.5]

# Forecast parameters
forecast:
  # Target year
  target_year: 2025

  # Number of periods to forecast (months)
  forecast_periods: 12

  # Confidence intervals
  confidence_level: 0.95

# Visualization settings
visualization:
  # Plotly theme
  theme: "plotly_white"

  # Color scheme
  colors:
    actual: "blue"
    model_a: "green"
    model_b: "red"
    current_method: "gray"
    baseline: "orange"

  # Figure size
  figure_height: 1200
  figure_width: 1400

  # Export formats
  export_formats:
    - "html"
    - "png"

# ==============================================================================
# WORKING DAYS FEATURE CONFIGURATION
# ==============================================================================
working_days_feature:
  # File location
  file: "TRAVECO_Arbeitstage_2022-laufend_fÃ¼r gopf.com_hb v2.xlsx"

  # Thresholds for feature inclusion (based on correlation analysis)
  correlation_threshold: 0.3
  pvalue_threshold: 0.01

  # Operational metrics that should use working_days (correlation analysis results)
  # Analysis: scripts/analyze_working_days_correlation.py
  # Output: data/processed/working_days_correlation_analysis.csv
  operational_metrics_with_working_days:
    - "total_orders"       # r = 0.825 (very strong)
    - "total_km_billed"    # r = 0.804 (very strong)
    - "total_drivers"      # r = 0.832 (very strong)
    - "total_tours"        # r = 0.710 (strong)
    - "revenue_total"      # r = 0.634 (strong)
    - "vehicle_time_cost"  # r = 0.615 (strong)
    - "total_vehicle_cost" # r = 0.599 (strong)
    - "total_km_actual"    # r = 0.585 (strong)
    - "vehicle_km_cost"    # r = 0.562 (moderate)

  # Metrics excluded from working_days feature (low/insignificant correlation)
  operational_metrics_without_working_days:
    - "external_drivers"   # r = 0.278, p = 0.10 (not significant)

  # Financial metrics with working_days (from financial pipeline)
  # Note: Financial correlations are NEGATIVE (more days = lower per-day averages)
  financial_metrics_with_working_days:
    - "total_revenue"          # r = -0.572
    - "total_betriebsertrag"   # r = -0.568
    - "ebt"                    # r = -0.503

  # Financial metrics excluded
  financial_metrics_without_working_days:
    - "personnel_costs"        # r = -0.251 (weak)
    - "external_driver_costs"  # r = 0.203 (weak)

# Logging
logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  file: "logs/forecasting.log"
  console: true

# ==============================================================================
# REVENUE PERCENTAGE MODELING (NEW)
# ==============================================================================
revenue_modeling:
  # Enable both modeling approaches
  enable_percentage_model: true  # Simple historical ratio approach
  enable_ml_model: true           # ML-based ratio prediction

  # Minimum months of historical data required for ML model
  min_history_months: 24

  # Ensemble weights (if both models used)
  # Will auto-adjust based on validation performance
  default_weights:
    percentage_model: 0.3
    ml_model: 0.7

  # Validation thresholds for model selection
  ml_mape_threshold_excellent: 3.0  # If ML MAPE < 3%, use 80% ML
  ml_mape_threshold_poor: 10.0      # If ML MAPE > 10%, use 100% simple

  # Revenue ratio outlier detection
  ratio_outlier_threshold: 2.5  # Flag ratios > 2.5 std deviations

  # Revenue validation rules
  revenue_ratio_min: 1.0      # Total revenue must be >= transport revenue
  revenue_ratio_max: 2.0      # Alert if ratio > 2x (likely data error)

# ==============================================================================
# CLI DEFAULTS
# ==============================================================================
cli:
  default_output_dir: "../results"
  default_forecast_file: "../data/forecasts/latest.csv"
  auto_backup: true  # Backup before overwriting

# ==============================================================================
# STREAMLIT DASHBOARD
# ==============================================================================
dashboard:
  title: "Traveco Forecasting System"
  page_icon: "ðŸ“Š"
  layout: "wide"

  # Data refresh
  cache_ttl: 300  # seconds

  # Display options
  show_debug_info: false
  decimal_places: 2
  thousands_separator: ","
